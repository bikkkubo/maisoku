# mysoku-renamer

日本の不動産「マイソク」PDFから物件情報（売買/賃貸、物件名、価格/家賃）を自動抽出し、統一された命名規則でファイル名をリネームするツールです。

## 目的・機能概要

### 目的
- マイソクPDFファイルの命名を統一し、検索・管理を効率化
- 手動リネーム作業の自動化による工数削減
- ファイル名から物件の基本情報を即座に判別可能にする

### 主要機能
- **PDF解析**: pypdfによるテキスト埋め込みPDF情報抽出
- **物件分類**: 売買・賃貸・その他の自動判定
- **価格正規化**: 億円・万円・円表記の統一化
- **安全運用**: ドライランモード、自動ロールバック記録
- **衝突回避**: 同名ファイル時の自動連番付与（-1, -2...）
- **エラー処理**: 失敗時継続 or 即座停止の選択可能

## 命名規則

| 分類 | 命名形式 | 例 |
|------|----------|-----|
| **売買** | `【売買】<物件名>_<価格N.X億円\|価格N,NNN万円>` | `【売買】グランドタワー渋谷_価格1.2億円.pdf` |
| **賃貸** | `【賃貸】<物件名>_家賃<金額>円` | `【賃貸】レジデンス恵比寿_家賃180,000円.pdf` |
| **その他** | `【その他】<物件名\|元ファイル名>_未確定` | `【その他】高級マンション_未確定.pdf` |

### 価格表示ルール
- **1億円以上**: `N.X億円` (小数1桁、例: 1.2億円)
- **1億円未満**: `N,NNN万円` (カンマ区切り、例: 8,500万円)
- **賃貸**: `N,NNN円` (カンマ区切り、例: 180,000円)

## インストール

### 1. 仮想環境作成（推奨）
```bash
python3 -m venv .venv
source .venv/bin/activate  # Linux/Mac
# または
.venv\Scripts\activate     # Windows
```

### 2. パッケージインストール
```bash
pip3 install -e .
```

### 3. 動作確認
```bash
mysoku-rename --help
```

## 使い方

### ⚠️ 重要: 安全運用の手順
1. **必ずドライランから開始** (`--dry-run`) してプレビュー確認
2. **バックアップ取得** 重要ファイルは事前にコピー
3. **小規模テスト** `--max-files 5` などで少数から実行
4. **ロールバックTSV保管** 万一の戻し作業用に保存

### 基本的な使用手順

#### Step 1: ドライラン（プレビュー）
```bash
# 単一ファイルのプレビュー
mysoku-rename --dry-run sample.pdf --output preview.tsv

# ディレクトリ一括プレビュー（最大10件）
mysoku-rename --dry-run ./pdfs --max-files 10 --debug --output preview.tsv

# 結果確認
head -5 preview.tsv
```

#### Step 2: 実行
```bash
# 同ディレクトリでリネーム（元ファイル名変更）
mysoku-rename --apply ./pdfs --max-files 10 --debug

# 別ディレクトリにコピー（元ファイル保持）
mysoku-rename --apply ./pdfs --outdir ./renamed_files --debug

# エラー時即座停止モード
mysoku-rename --apply ./pdfs --strict --debug
```

### オプション詳細

| オプション | 説明 | 例 |
|------------|------|-----|
| `--dry-run` | プレビューのみ（ファイル変更なし）| `--dry-run` |
| `--apply` | 実際にファイルをリネーム/コピー | `--apply` |
| `--outdir DIR` | コピー先ディレクトリ（元ファイル保持）| `--outdir ./output` |
| `--max-files N` | 処理ファイル数上限（デフォルト500）| `--max-files 50` |
| `--strict` | エラー時即座終了 | `--strict` |
| `--debug` | 詳細ログ出力 | `--debug` |
| `--logfile PATH` | ログファイル出力 | `--logfile run.log` |
| `--output PATH` | TSV出力先指定 | `--output result.tsv` |

## TSV出力仕様

### プレビューTSV（--dry-run）
```
path	status	kind	name	amount	text_length	new_name	notes
/path/file.pdf	OK	sell	グランドタワー	120000000	1500	【売買】グランドタワー_価格1.2億円.pdf	embedded_text_1500chars
```

| 列名 | 説明 | 例 |
|------|------|-----|
| `path` | 元ファイルパス | `/home/user/sample.pdf` |
| `status` | 処理状況 | `OK`, `ERROR` |
| `kind` | 取引種別 | `sell`, `rent`, `unknown` |
| `name` | 抽出物件名 | `グランドタワー渋谷` |
| `amount` | 抽出金額（円） | `120000000` |
| `text_length` | 抽出テキスト長 | `1500` |
| `new_name` | 生成ファイル名 | `【売買】物件名_価格1.2億円.pdf` |
| `notes` | 備考・エラー内容 | `needs_ocr`, `embedded_text_1500chars` |

### 適用結果TSV（--apply）
プレビューTSVの全列に加えて：

| 列名 | 説明 | 例 |
|------|------|-----|
| `actual_new_path` | 実際の出力パス（衝突回避後） | `/path/【売買】物件名_価格1.2億円-1.pdf` |
| `timestamp` | 実行時刻 | `2024-01-01T12:00:00.123456` |

### ロールバックTSV（自動生成: `mysoku_rollback_YYYYMMDD_HHMMSS.tsv`）
```
old_path	new_path	kind	name	amount	timestamp	notes
/old/file.pdf	/new/【売買】物件_1億円.pdf	sell	物件名	100000000	2024-01-01T12:00:00	rename_success
```

## よくある質問（FAQ）

### Q1: 物件名や金額が「未取得」になる場合の対処法は？
**A**: 以下を確認してください：
- PDFがテキスト埋め込み形式か（画像ベースPDFは現在未対応）
- 文字が正しく認識されているか（`--debug`で確認）
- 物件名に「物件名：」などの明示的ラベルがあるか

**未取得時の命名例**:
- 物件名のみ不明: `【売買】原ファイル名_価格1.2億円.pdf`  
- 金額のみ不明: `【売買】物件名_価格未取得.pdf`
- 両方不明: `【その他】原ファイル名_未確定.pdf`

### Q2: kindが「unknown」になる場合は？
**A**: 売買・賃貸の判定キーワードが見つからない場合です：
- **売買キーワード例**: 販売価格、売買、売出価格、分譲
- **賃貸キーワード例**: 賃料、家賃、管理費、敷金、礼金

判定不能の場合は `【その他】<物件名>_取引種別未取得.pdf` として処理されます。

### Q3: 同名ファイルがある場合はどうなる？
**A**: 自動で連番が付与されます：
```
【売買】物件名_価格1億円.pdf      # 1件目
【売買】物件名_価格1億円-1.pdf    # 2件目
【売買】物件名_価格1億円-2.pdf    # 3件目
```

### Q4: 失敗したファイルはどこで確認できる？
**A**: `errors.tsv`（自動生成）で確認できます：
```
original_path	error_type	error_message	timestamp
/path/bad.pdf	PDF_READ_ERROR	Cannot read PDF file	2024-01-01T12:00:00
```

### Q5: 処理を元に戻したい場合は？
**A**: 自動生成される`mysoku_rollback_YYYYMMDD_HHMMSS.tsv`を使用：
1. TSVファイルの`old_path`と`new_path`を確認
2. 手動でファイル名を戻すか、復元スクリプトを作成
3. 将来的には自動復元機能を提供予定

## トラブルシューティング

### エラー: "PDF読み込み失敗"
- ファイルが破損していないか確認
- 他のアプリケーションで開いていないか確認
- ファイル権限を確認

### エラー: "ディスク容量不足"
- `--outdir`使用時は十分な空き容量があるか確認
- 一時ファイルの容量も考慮

### 日本語文字化け
- システムのロケール設定確認
- UTF-8エンコーディング対応確認

## 安全運用ガイドライン

### ✅ 推奨手順
1. **小規模テスト**: `--max-files 5` で動作確認
2. **ドライラン必須**: `--dry-run`でプレビュー確認
3. **バックアップ**: 重要ファイルは事前コピー
4. **段階実行**: 一度に大量処理せず分割実行
5. **ログ保存**: `--logfile`でログ記録
6. **TSV保管**: ロールバック用TSVファイル保管

### ❌ 注意事項
- **一括大量処理禁止**: 必ず小規模から開始
- **バックアップなし実行禁止**: 重要データは必ずバックアップ
- **本番環境直実行禁止**: テスト環境での動作確認後に実行
- **ロールバックTSV削除禁止**: 復旧作業まで保管

### セキュリティ考慮事項
- PDFに個人情報が含まれる場合は適切な権限管理
- 処理ログに機密情報が含まれないよう注意
- ネットワーク共有フォルダでの実行時は権限確認

## ライセンス

MIT License

## サポート・貢献

- バグ報告: GitHubのIssues
- 機能要望: GitHubのIssues  
- プルリクエスト: 歓迎します