# SPEC: マイソクPDF自動リネーム

## 1. 目的 / 成果物
- 目的: マイソクPDFから主要情報を抽出し、命名規則に従って安全にファイル名を変更する。
- 成果物: 人手検索しやすい命名（売買/賃貸区別＋物件名＋価格/家賃）で保存。

## 2. 前提 / 制約
- 対象範囲（In）: 日本語マイソクPDF（テキスト埋め込み優先、OCRはオプション）
- 非対象（Out）: 画像スキャン品質が極端に悪いものの高度補正、レイアウト自動判別の高精度最適化
- 技術/運用制約: 
  - **抽出ロジック前提**: PDF埋込テキスト優先処理（pypdf使用）
  - **OCR方針**: テキスト抽出失敗時のOCRは別タスク(T7)で検討・実装
  - 最大処理ファイル数: 500件/回
  - 依存追加は最小

## 3. 要件（必須のみ）
- 機能要件:
  - 単一/複数PDFに対し、**ドライラン**で新ファイル名のプレビューを出力
  - 実行許可後、既存ファイルと衝突しないように保存（重複時は連番 `-1` `-2` …）
  - 抽出項目:
    - 取引別: 売買 or 賃貸
    - 物件名: 正式建物名（ノイズ語除去ルール適用）
      - 除去対象: 号室/階数/部屋番号/掲載用/チラシ/新着/価格改定/更新日/No.、括弧付きマーク
      - 優先順: ①「物件名」欄 → ②1ページ目最大フォント行 → ③ノイズ最少のタイトル候補
    - 価格/家賃: 通貨・単位正規化
      - 売買: 1億円以上は`N.X億円`（小数1桁）、1億円未満は`N,NNN万円`
      - 賃貸: カンマ区切り円表記（例：210,000円）
  - 命名規則（確定版）:
    - 売買: `【売買】<物件名>_<価格N億円 | 価格N,NNN万円>`
      - 例: 「【売買】グランドメゾン青山_価格2.3億円.pdf」
      - 例: 「【売買】パークハウス新宿_価格8,500万円.pdf」
    - 賃貸: `【賃貸】<物件名>_家賃<金額>円`
      - 例: 「【賃貸】レジデンス恵比寿_家賃180,000円.pdf」
- 非機能要件:
  - ログレベル:
    - 既定: INFO最小（件数・失敗数・主要サマリ）
    - `--debug` 指定時: 詳細ログ＋スタックトレース
    - `--logfile` 指定時のみファイル保存
  - 大量ファイル時は進捗とエラーを簡易表示

## 4. 入出力・IF
- 入力: PDFファイルパス（1件 or ディレクトリ）
- 出力: 
  - 既定: 同ディレクトリでリネーム
  - `--outdir` 指定時: コピー保存（元は保持）
- CLI引数詳細:
  - 基本: `mysoku-rename {--dry-run|--apply} <path>`
  - オプション: `[--outdir DIR] [--strict] [--max-files N] [--debug] [--logfile PATH]`
  - 将来拡張: `[--ocr]` （T7フェーズで実装）
- 出力TSV形式:
  - **プレビューTSV** (--dry-run): `original_path,new_filename,transaction_type,property_name,price_normalized,status,error_message`
  - **実行結果TSV** (--apply): 上記に加え `timestamp,actual_new_path`
  - **エラーTSV** (errors.tsv): `original_path,error_type,error_message,timestamp`
  - **ロールバックTSV** (rollback_*.tsv): `old_path,new_path,timestamp`

## 5. エッジケース / エラー方針
- **売買/賃貸不明時**: 
  - 命名: `【その他】<物件名>_取引種別未取得`
  - 処理: 通常処理継続、TSVのtransaction_type列に"その他"記録
- **価格/家賃未取得時**: 
  - 売買: `【売買】<物件名>_価格未取得`
  - 賃貸: `【賃貸】<物件名>_家賃未取得`
  - 処理: 通常処理継続、TSVのprice_normalized列に"未取得"記録
- **物件名未取得時**: 
  - 命名: `【<取引種別>】物件名未取得_<価格部>`
  - 処理: 原ファイル名ベースの fallback 実行
- エラー時の動作:
  - 既定: スキップ継続（終了コード0、errors.tsvに記録）
  - `--strict` 指定時: エラー発生時に非0終了
- OCR起動条件: 抽出テキスト長が200文字未満などの閾値時のみ
- ロールバック: apply時に old_path,new_path のTSV保存必須

## 6. 受入条件（Acceptance Criteria）
- **AC1-売買ケース**: 
  - 入力: 売買マイソクPDF（価格1.5億円、物件名「グランドメゾン青山」）
  - 期待出力: 「【売買】グランドメゾン青山_価格1.5億円.pdf」
- **AC2-賃貸ケース**: 
  - 入力: 賃貸マイソクPDF（家賃18万円、物件名「レジデンス恵比寿」）
  - 期待出力: 「【賃貸】レジデンス恵比寿_家賃180,000円.pdf」
- **AC3-不明ケース**: 
  - 入力: 取引種別判別不明PDF（物件名のみ抽出可能）
  - 期待出力: 「【その他】物件名_取引種別未取得.pdf」
- **共通受入条件**:
  - 衝突時に連番付与で失敗しない
  - `--dry-run` と `--apply` の結果整合が取れている（件数/エラー一致）
  - TSV出力の列構成が仕様通り

## 7. 検討除外
- 高度なレイアウト学習、端末ごとのOCR最適化、自動外部API課金利用
- OCRは tesseract (jpn,jpn_vert) 採用、不十分時は ocrmypdf を候補とする
